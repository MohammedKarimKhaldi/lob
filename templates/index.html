<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limit Order Book Simulation</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <!-- Custom CSS -->
    <style>
        .orderbook-container {
            height: 400px;
            border: 1px solid #ddd;
            margin: 20px 0;
        }
        
        .price-chart {
            height: 300px;
            border: 1px solid #ddd;
            margin: 20px 0;
        }
        
        .metrics-panel {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .bid-level {
            fill: #d4edda;
            stroke: #28a745;
        }
        
        .ask-level {
            fill: #f8d7da;
            stroke: #dc3545;
        }
        
        .mid-price-line {
            stroke: #007bff;
            stroke-width: 2;
            stroke-dasharray: 5,5;
        }
        
        .trade-marker {
            fill: #ffc107;
            stroke: #e0a800;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-running {
            background-color: #28a745;
        }
        
        .status-stopped {
            background-color: #dc3545;
        }
        
        .status-not-started {
            background-color: #6c757d;
        }
        
        .strategy-config {
            background-color: #f8f9fa;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .form-check {
            margin-bottom: 0.5rem;
        }
        
        .strategy-performance .card {
            transition: transform 0.2s;
        }
        
        .strategy-performance .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1 class="mt-3 mb-4">
                    <span class="status-indicator" id="statusIndicator"></span>
                    Limit Order Book Simulation
                </h1>
            </div>
        </div>
        
        <!-- Control Panel -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Simulation Controls</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="duration" class="form-label">Duration (seconds)</label>
                                <input type="number" class="form-control" id="duration" value="3600" min="60" max="86400">
                            </div>
                            <div class="col-md-3">
                                <label for="initialPrice" class="form-label">Initial Price</label>
                                <input type="number" class="form-control" id="initialPrice" value="100.0" step="0.01" min="1">
                            </div>
                            <div class="col-md-3">
                                <label for="tickSize" class="form-label">Tick Size</label>
                                <input type="number" class="form-control" id="tickSize" value="0.01" step="0.001" min="0.001">
                            </div>
                            <div class="col-md-3">
                                <label for="maxLevels" class="form-label">Max Levels</label>
                                <input type="number" class="form-control" id="maxLevels" value="10" min="5" max="50">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-3">
                                <label for="numInformed" class="form-label">Informed Traders</label>
                                <input type="number" class="form-control" id="numInformed" value="5" min="1" max="50">
                            </div>
                            <div class="col-md-3">
                                <label for="numUninformed" class="form-label">Uninformed Traders</label>
                                <input type="number" class="form-control" id="numUninformed" value="20" min="1" max="100">
                            </div>
                            <div class="col-md-3">
                                <label for="numMarketMakers" class="form-label">Market Makers</label>
                                <input type="number" class="form-control" id="numMarketMakers" value="3" min="1" max="20">
                            </div>
                            <div class="col-md-3">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" id="startBtn" onclick="startSimulation()">Start Simulation</button>
                                    <button class="btn btn-danger" id="stopBtn" onclick="stopSimulation()" disabled>Stop Simulation</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Strategy Configuration -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>Strategy Configuration</h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="enableMarketMaking" checked>
                                            <label class="form-check-label" for="enableMarketMaking">
                                                Market Making
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="enableMomentum" checked>
                                            <label class="form-check-label" for="enableMomentum">
                                                Momentum Trading
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="enableMeanReversion" checked>
                                            <label class="form-check-label" for="enableMeanReversion">
                                                Mean Reversion
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="enableArbitrage" checked>
                                            <label class="form-check-label" for="enableArbitrage">
                                                Arbitrage
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="strategyCapital" class="form-label">Strategy Capital ($)</label>
                                        <input type="number" class="form-control" id="strategyCapital" value="100000" min="10000" step="10000">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="maxPosition" class="form-label">Max Position</label>
                                        <input type="number" class="form-control" id="maxPosition" value="500" min="100" step="100">
                                    </div>
                                </div>
                                
                                <!-- Strategy Presets -->
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <small class="text-muted">Quick Presets:</small>
                                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="loadPreset('conservative')">Conservative</button>
                                        <button class="btn btn-sm btn-outline-warning ms-1" onclick="loadPreset('aggressive')">Aggressive</button>
                                        <button class="btn btn-sm btn-outline-info ms-1" onclick="loadPreset('balanced')">Balanced</button>
                                        <button class="btn btn-sm btn-outline-secondary ms-1" onclick="loadPreset('market_making_only')">Market Making Only</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Metrics Panel -->
        <div class="row">
            <div class="col-12">
                <div class="metrics-panel">
                    <div class="row">
                        <div class="col-md-2">
                            <strong>Current Time:</strong><br>
                            <span id="currentTime">0.0s</span>
                        </div>
                        <div class="col-md-2">
                            <strong>Mid Price:</strong><br>
                            <span id="midPrice">$0.00</span>
                        </div>
                        <div class="col-md-2">
                            <strong>Spread:</strong><br>
                            <span id="spread">$0.00</span>
                        </div>
                        <div class="col-md-2">
                            <strong>Best Bid:</strong><br>
                            <span id="bestBid">$0.00</span>
                        </div>
                        <div class="col-md-2">
                            <strong>Best Ask:</strong><br>
                            <span id="bestAsk">$0.00</span>
                        </div>
                        <div class="col-md-2">
                            <strong>Total Trades:</strong><br>
                            <span id="totalTrades">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Visualization Panels -->
        <div class="row">
            <!-- Order Book Depth Chart -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Order Book Depth</h5>
                    </div>
                    <div class="card-body">
                        <div id="orderbookChart" class="orderbook-container"></div>
                    </div>
                </div>
            </div>
            
            <!-- Price Evolution Chart -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Price Evolution</h5>
                    </div>
                    <div class="card-body">
                        <div id="priceChart" class="price-chart"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Strategy Performance -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Strategy Performance</h5>
                    </div>
                    <div class="card-body">
                        <div id="strategy-performance" class="row">
                            <!-- Strategy performance cards will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Trades -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Recent Trades</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Trade ID</th>
                                        <th>Price</th>
                                        <th>Quantity</th>
                                    </tr>
                                </thead>
                                <tbody id="tradesTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Global variables
        let socket;
        let orderbookChart, priceChart;
        let priceData = [];
        let orderbookData = { bids: [], asks: [] };
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            initializeCharts();
            updateStatus('not_started');
        });
        
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to server');
            });
            
            socket.on('simulation_update', function(data) {
                updateVisualization(data);
            });
            
            socket.on('status', function(data) {
                console.log('Status:', data.message);
            });
        }
        
        function initializeCharts() {
            // Initialize Order Book Chart
            const orderbookContainer = document.getElementById('orderbookChart');
            const orderbookWidth = orderbookContainer.clientWidth;
            const orderbookHeight = orderbookContainer.clientHeight;
            
            orderbookChart = d3.select('#orderbookChart')
                .append('svg')
                .attr('width', orderbookWidth)
                .attr('height', orderbookHeight);
            
            // Initialize Price Chart
            const priceContainer = document.getElementById('priceChart');
            const priceWidth = priceContainer.clientWidth;
            const priceHeight = priceContainer.clientHeight;
            
            priceChart = d3.select('#priceChart')
                .append('svg')
                .attr('width', priceWidth)
                .attr('height', priceHeight);
        }
        
        function updateVisualization(data) {
            console.log('Received update data:', data);
            
            updateMetrics(data.metrics);
            updateOrderbookChart(data.orderbook);
            updatePriceChart(data.price_history);
            updateTradesTable(data.recent_trades);
            updateStrategyPerformance(data.strategy_performance);
        }
        
        function updateMetrics(metrics) {
            document.getElementById('currentTime').textContent = metrics.timestamp.toFixed(1) + 's';
            document.getElementById('midPrice').textContent = '$' + metrics.mid_price.toFixed(2);
            document.getElementById('spread').textContent = '$' + metrics.spread.toFixed(4);
            document.getElementById('bestBid').textContent = '$' + (metrics.mid_price - metrics.spread/2).toFixed(2);
            document.getElementById('bestAsk').textContent = '$' + (metrics.mid_price + metrics.spread/2).toFixed(2);
            document.getElementById('totalTrades').textContent = metrics.num_trades;
        }
        
        function updateOrderbookChart(orderbook) {
            if (!orderbook || !orderbook.depth) return;
            
            const container = document.getElementById('orderbookChart');
            const width = container.clientWidth;
            const height = container.clientHeight;
            const margin = { top: 20, right: 20, bottom: 30, left: 60 };
            
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            // Clear previous chart
            orderbookChart.selectAll('*').remove();
            
            const svg = orderbookChart
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Prepare data
            const bids = orderbook.depth.bids || [];
            const asks = orderbook.depth.asks || [];
            
            // Scales
            const priceExtent = d3.extent([...bids.map(d => d[0]), ...asks.map(d => d[0])]);
            const xScale = d3.scaleLinear()
                .domain(priceExtent)
                .range([0, chartWidth]);
            
            const maxVolume = d3.max([...bids.map(d => d[1]), ...asks.map(d => d[1])]);
            const yScale = d3.scaleLinear()
                .domain([0, maxVolume])
                .range([chartHeight, 0]);
            
            // Draw bid levels
            svg.selectAll('.bid-level')
                .data(bids)
                .enter()
                .append('rect')
                .attr('class', 'bid-level')
                .attr('x', d => xScale(d[0]))
                .attr('y', d => yScale(d[1]))
                .attr('width', 20)
                .attr('height', d => chartHeight - yScale(d[1]));
            
            // Draw ask levels
            svg.selectAll('.ask-level')
                .data(asks)
                .enter()
                .append('rect')
                .attr('class', 'ask-level')
                .attr('x', d => xScale(d[0]))
                .attr('y', d => yScale(d[1]))
                .attr('width', 20)
                .attr('height', d => chartHeight - yScale(d[1]));
            
            // Draw mid price line
            if (orderbook.mid_price) {
                svg.append('line')
                    .attr('class', 'mid-price-line')
                    .attr('x1', xScale(orderbook.mid_price))
                    .attr('x2', xScale(orderbook.mid_price))
                    .attr('y1', 0)
                    .attr('y2', chartHeight);
            }
            
            // Axes
            const xAxis = d3.axisBottom(xScale);
            const yAxis = d3.axisLeft(yScale);
            
            svg.append('g')
                .attr('transform', `translate(0,${chartHeight})`)
                .call(xAxis);
            
            svg.append('g')
                .call(yAxis);
        }
        
        function updatePriceChart(priceHistory) {
            if (!priceHistory || priceHistory.length === 0) {
                console.log('No price history data available');
                return;
            }
            
            console.log('Updating price chart with', priceHistory.length, 'data points');
            
            const container = document.getElementById('priceChart');
            const width = container.clientWidth;
            const height = container.clientHeight;
            const margin = { top: 20, right: 20, bottom: 30, left: 60 };
            
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            // Clear previous chart
            priceChart.selectAll('*').remove();
            
            const svg = priceChart
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Ensure we have valid data
            const validData = priceHistory.filter(d => 
                d && typeof d.timestamp === 'number' && typeof d.mid_price === 'number'
            );
            
            if (validData.length === 0) {
                console.log('No valid price data found');
                return;
            }
            
            // Scales with padding
            const xExtent = d3.extent(validData, d => d.timestamp);
            const yExtent = d3.extent(validData, d => d.mid_price);
            
            const xScale = d3.scaleLinear()
                .domain(xExtent)
                .range([0, chartWidth]);
            
            const yScale = d3.scaleLinear()
                .domain(yExtent)
                .range([chartHeight, 0])
                .nice();
            
            // Line generator
            const line = d3.line()
                .x(d => xScale(d.timestamp))
                .y(d => yScale(d.mid_price))
                .curve(d3.curveMonotoneX);
            
            // Draw price line
            svg.append('path')
                .datum(validData)
                .attr('fill', 'none')
                .attr('stroke', '#007bff')
                .attr('stroke-width', 2)
                .attr('d', line);
            
            // Add grid lines
            svg.append('g')
                .attr('class', 'grid')
                .attr('transform', `translate(0,${chartHeight})`)
                .call(d3.axisBottom(xScale).tickSize(-chartHeight).tickFormat(''));
            
            svg.append('g')
                .attr('class', 'grid')
                .call(d3.axisLeft(yScale).tickSize(-chartWidth).tickFormat(''));
            
            // Axes
            const xAxis = d3.axisBottom(xScale);
            const yAxis = d3.axisLeft(yScale);
            
            svg.append('g')
                .attr('transform', `translate(0,${chartHeight})`)
                .call(xAxis);
            
            svg.append('g')
                .call(yAxis);
            
            // Add labels
            svg.append('text')
                .attr('x', chartWidth / 2)
                .attr('y', chartHeight + margin.bottom - 5)
                .style('text-anchor', 'middle')
                .text('Time (seconds)');
            
            svg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', -margin.left + 15)
                .attr('x', -chartHeight / 2)
                .style('text-anchor', 'middle')
                .text('Price ($)');
        }
        
        function updateTradesTable(trades) {
            const tbody = document.getElementById('tradesTable');
            tbody.innerHTML = '';
            
            if (!trades || trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">No trades yet</td></tr>';
                return;
            }
            
            trades.slice(-10).reverse().forEach(trade => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${trade.timestamp.toFixed(1)}s</td>
                    <td>${trade.trade_id}</td>
                    <td>$${trade.price.toFixed(2)}</td>
                    <td>${trade.quantity}</td>
                `;
            });
        }
        
        function updateStrategyPerformance(strategyPerformance) {
            const container = document.getElementById('strategy-performance');
            
            if (!strategyPerformance || Object.keys(strategyPerformance).length === 0) {
                container.innerHTML = '<div class="col-12"><p class="text-center">No strategies running</p></div>';
                return;
            }
            
            container.innerHTML = '';
            
            Object.entries(strategyPerformance).forEach(([strategyName, perf]) => {
                const pnlColor = perf.total_pnl >= 0 ? 'text-success' : 'text-danger';
                const card = document.createElement('div');
                card.className = 'col-md-3 mb-3';
                card.innerHTML = `
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="card-title mb-0">${strategyName.replace('_', ' ').toUpperCase()}</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6">
                                    <p class="mb-1"><small>Total PnL:</small></p>
                                    <p class="mb-1"><small>Win Rate:</small></p>
                                    <p class="mb-1"><small>Sharpe:</small></p>
                                    <p class="mb-1"><small>Trades:</small></p>
                                </div>
                                <div class="col-6">
                                    <p class="mb-1 ${pnlColor}"><strong>$${perf.total_pnl.toFixed(2)}</strong></p>
                                    <p class="mb-1"><strong>${(perf.win_rate * 100).toFixed(1)}%</strong></p>
                                    <p class="mb-1"><strong>${perf.sharpe_ratio.toFixed(2)}</strong></p>
                                    <p class="mb-1"><strong>${perf.num_trades}</strong></p>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    Position: ${perf.current_position} | 
                                    Max DD: ${(perf.max_drawdown * 100).toFixed(1)}%
                                </small>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        function loadPreset(preset) {
            switch(preset) {
                case 'conservative':
                    // Conservative: Market making and mean reversion only
                    document.getElementById('enableMarketMaking').checked = true;
                    document.getElementById('enableMomentum').checked = false;
                    document.getElementById('enableMeanReversion').checked = true;
                    document.getElementById('enableArbitrage').checked = false;
                    document.getElementById('strategyCapital').value = 50000;
                    document.getElementById('maxPosition').value = 200;
                    break;
                    
                case 'aggressive':
                    // Aggressive: All strategies with high capital
                    document.getElementById('enableMarketMaking').checked = true;
                    document.getElementById('enableMomentum').checked = true;
                    document.getElementById('enableMeanReversion').checked = true;
                    document.getElementById('enableArbitrage').checked = true;
                    document.getElementById('strategyCapital').value = 200000;
                    document.getElementById('maxPosition').value = 1000;
                    break;
                    
                case 'balanced':
                    // Balanced: All strategies with moderate settings
                    document.getElementById('enableMarketMaking').checked = true;
                    document.getElementById('enableMomentum').checked = true;
                    document.getElementById('enableMeanReversion').checked = true;
                    document.getElementById('enableArbitrage').checked = true;
                    document.getElementById('strategyCapital').value = 100000;
                    document.getElementById('maxPosition').value = 500;
                    break;
                    
                case 'market_making_only':
                    // Market making only
                    document.getElementById('enableMarketMaking').checked = true;
                    document.getElementById('enableMomentum').checked = false;
                    document.getElementById('enableMeanReversion').checked = false;
                    document.getElementById('enableArbitrage').checked = false;
                    document.getElementById('strategyCapital').value = 75000;
                    document.getElementById('maxPosition').value = 300;
                    break;
            }
        }
        
        function updateStatus(status) {
            const indicator = document.getElementById('statusIndicator');
            indicator.className = 'status-indicator status-' + status;
            
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            if (status === 'running') {
                startBtn.disabled = true;
                stopBtn.disabled = false;
            } else {
                startBtn.disabled = false;
                stopBtn.disabled = true;
            }
        }
        
        function startSimulation() {
            const config = {
                duration: parseFloat(document.getElementById('duration').value),
                initial_price: parseFloat(document.getElementById('initialPrice').value),
                tick_size: parseFloat(document.getElementById('tickSize').value),
                max_levels: parseInt(document.getElementById('maxLevels').value),
                num_informed_traders: parseInt(document.getElementById('numInformed').value),
                num_uninformed_traders: parseInt(document.getElementById('numUninformed').value),
                num_market_makers: parseInt(document.getElementById('numMarketMakers').value)
            };
            
            // Get strategy configuration
            const strategies = [];
            const strategyCapital = parseFloat(document.getElementById('strategyCapital').value);
            const maxPosition = parseInt(document.getElementById('maxPosition').value);
            
            if (document.getElementById('enableMarketMaking').checked) {
                strategies.push({
                    name: 'market_making',
                    params: {
                        initial_capital: strategyCapital,
                        max_position: maxPosition,
                        max_order_size: Math.floor(maxPosition / 10),
                        min_spread: 0.01,
                        max_spread: 0.05
                    }
                });
            }
            
            if (document.getElementById('enableMomentum').checked) {
                strategies.push({
                    name: 'momentum',
                    params: {
                        initial_capital: strategyCapital,
                        max_position: maxPosition,
                        max_order_size: Math.floor(maxPosition / 10),
                        lookback_period: 15,
                        momentum_threshold: 0.015
                    }
                });
            }
            
            if (document.getElementById('enableMeanReversion').checked) {
                strategies.push({
                    name: 'mean_reversion',
                    params: {
                        initial_capital: strategyCapital,
                        max_position: maxPosition,
                        max_order_size: Math.floor(maxPosition / 10),
                        lookback_period: 25,
                        mean_reversion_threshold: 0.025
                    }
                });
            }
            
            if (document.getElementById('enableArbitrage').checked) {
                strategies.push({
                    name: 'arbitrage',
                    params: {
                        initial_capital: strategyCapital,
                        max_position: maxPosition,
                        max_order_size: Math.floor(maxPosition / 10),
                        arbitrage_threshold: 0.008
                    }
                });
            }
            
            const requestData = {
                ...config,
                strategies: strategies
            };
            
            fetch('/api/start_simulation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'started') {
                    updateStatus('running');
                    console.log('Simulation started with strategies:', data.strategies);
                } else {
                    console.error('Failed to start simulation:', data.error);
                }
            })
            .catch(error => {
                console.error('Error starting simulation:', error);
            });
        }
        
        function stopSimulation() {
            fetch('/api/stop_simulation', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'stopped') {
                    updateStatus('stopped');
                    console.log('Simulation stopped');
                }
            })
            .catch(error => {
                console.error('Error stopping simulation:', error);
            });
        }
        
        // Handle window resize
        window.addEventListener('resize', function() {
            // Reinitialize charts on resize
            setTimeout(() => {
                initializeCharts();
            }, 100);
        });
    </script>
</body>
</html> 